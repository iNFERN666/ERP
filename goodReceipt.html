<!DOCTYPE html>
<html>

<head>
  <title>Styled Good Receipt</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 20px;
      overflow-y: hidden;
      /* Ascunde bara de derulare verticală */
    }

    h2 {
      font-size: 1.8em;
      color: #336699;
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #336699;
    }

    #cameraFeed {
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
      margin-top: 20px;
      overflow: hidden;
    }

    input[type="text"],
    input[type="number"],
    input[type="submit"] {
      width: calc(100% - 20px);
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    input[type="submit"] {
      background-color: #336699;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    input[type="submit"]:hover {
      background-color: #1e4b8d;
    }

    /* Ascunde bara de derulare pentru browserele WebKit */
    ::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body>

  <h2>Good Receipt</h2>
  <form id="goodReceiptForm">
    <select id="cameraSelect"></select>
    <div id="cameraFeed"></div>
    <label for="materialDescription">Material Description:</label>
    <input type="text" id="materialDescription" name="materialDescription" required><br><br>

    <label for="materialCode">Material Code:</label>
    <input type="text" id="materialCode" name="materialCode" required oninput="updateMaterialDescription()"><br><br>

    <label for="quantity">Quantity:</label>
    <input type="number" id="quantity" name="quantity" required><br><br>

    <label for="price">Price:</label>
    <input type="number" id="price" name="price" required><br><br>

    <input type="submit" value="Submit" onclick="submitGoodReceipt(event)">
  </form>

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

  <script>
    // Your Firebase configuration here
    const firebaseConfig = {
      apiKey: "AIzaSyCocj-iFXprN6X3lDc6Cu3xaNkCfRiUY20",
      authDomain: "nextgenfactory-future.firebaseapp.com",
      databaseURL: "https://nextgenfactory-future-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "nextgenfactory-future",
      storageBucket: "nextgenfactory-future.appspot.com",
      messagingSenderId: "656505366836",
      appId: "1:656505366836:web:6de30ad6040345a2b8dd61",
      measurementId: "G-CJC3F3QHY9"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    // Funcție pentru a porni camera
    function startCamera() {
      const cameraFeed = document.getElementById('cameraFeed');
      const cameraSelect = document.getElementById('cameraSelect');

      // Obtine informatii despre dispozitivele media (camere)
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const videoDevices = devices.filter(device => device.kind === 'videoinput');

          if (videoDevices.length === 0) {
            console.error('Nu s-au gasit camere video disponibile.');
            return;
          }

          // Adauga camerele disponibile in lista de selectare
          videoDevices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.text = `Camera ${index + 1}`;
            cameraSelect.appendChild(option);
          });

          // Porneste camera cu dispozitivul selectat
          startCameraStream(cameraSelect.value);
        })
        .catch(error => {
          console.error('Eroare la enumerarea dispozitivelor media:', error);
        });

      // Adauga un eveniment pentru schimbarea camerei selectate
      cameraSelect.addEventListener('change', () => {
        startCameraStream(cameraSelect.value);
      });
    }

    // Functie pentru pornirea fluxului de date video de pe camera selectata
    function startCameraStream(deviceId) {
      const cameraFeed = document.getElementById('cameraFeed');

      Quagga.init({
        inputStream: {
          name: 'Live',
          type: 'LiveStream',
          target: cameraFeed,
          constraints: {
            deviceId: deviceId
          }
        },
        decoder: {
          readers: ['code_128_reader'], // Puteți adăuga mai mulți cititori dacă este necesar
        },
        canvas: {
          willReadFrequently: true, // Set willReadFrequently la true pentru o performanță mai bună
        },
      }, (err) => {
        if (err) {
          console.error('Eroare la inițializarea Quagga:', err);
          return;
        }

        Quagga.start();
      });
    }

    // Apelarea funcției pentru a porni camera atunci când pagina este încărcată complet
    window.onload = startCamera;

    // Funcție pentru a actualiza descrierea materialului bazată pe codul materialului
    function updateMaterialDescription() {
      const materialCodeInput = document.getElementById('materialCode');
      const materialDescriptionInput = document.getElementById('materialDescription');

      const materialCode = materialCodeInput.value;

      const databaseRef = firebase.database().ref('yourDatabasePath'); // Actualizați cu calea dvs. reală

      databaseRef.orderByChild('materialCode').equalTo(materialCode).once('value', (snapshot) => {
        const existingData = snapshot.val();

        if (existingData) {
          const matchingEntries = Object.values(existingData).filter(item => item.materialCode === materialCode);

          if (matchingEntries.length > 0) {
            // Dacă materialul există, actualizați câmpul de introducere pentru descrierea materialului
            materialDescriptionInput.value = matchingEntries[0].materialDescription;
          } else {
            // Dacă materialul nu există, lăsați câmpul de introducere pentru descrierea materialului neschimbat
          }
        } else {
          // Dacă nu există date, lăsați câmpul de introducere pentru descrierea materialului neschimbat
        }
      });
    }

    // Funcție pentru a trimite formularul Good Receipt
    function submitGoodReceipt(event) {
      event.preventDefault();

      const materialDescription = document.getElementById('materialDescription').value;
      const materialCode = document.getElementById('materialCode').value;
      const price = parseFloat(document.getElementById('price').value);
      const quantity = parseFloat(document.getElementById('quantity').value);

      if (isNaN(quantity)) {
        console.error('Cantitatea nu este un număr valid.');
        return;
      }

      console.log('Cod material:', materialCode);
      console.log('Descrierea materialului:', materialDescription);
      console.log('Preț:', price);
      console.log('Cantitate:', quantity);

      const databaseRef = firebase.database().ref('goodReceipts');

      databaseRef.orderByChild('materialCode').equalTo(materialCode).once('value', (snapshot) => {
        const existingData = snapshot.val();

        if (existingData) {
          const matchingEntries = Object.values(existingData).filter(item => item.materialCode === materialCode && item.price === price);

          if (matchingEntries.length > 0) {
            const matchedItem = matchingEntries[0];
            const updatedQuantity = matchedItem.quantity + quantity;

            const matchedItemId = Object.keys(existingData).find(key => existingData[key].materialCode === materialCode && existingData[key].price === price);

            databaseRef.child(matchedItemId).update({
              quantity: updatedQuantity
            })
              .then(() => {
                console.log('Cantitate actualizată pentru materialul existent cu același cod și preț.');
              })
              .catch((error) => {
                console.error('Eroare la actualizarea cantității:', error);
              });
          } else {
            addNewEntry(materialCode, materialDescription, price, quantity);
          }
        } else {
          addNewEntry(materialCode, materialDescription, price, quantity);
        }
      });
    }

    // Funcție pentru a adăuga o intrare nouă
    function addNewEntry(materialCode, materialDescription, price, quantity) {
      const databaseRef = firebase.database().ref('goodReceipts');

      databaseRef.push({
        materialCode: materialCode,
        materialDescription: materialDescription,
        price: price,
        quantity: quantity
      })
        .then(() => {
          console.log('Intrare nouă adăugată pentru codul materialului:', materialCode);
          console.log('Cod material:', materialCode);
          console.log('Descrierea materialului:', materialDescription);
          console.log('Preț:', price);
          console.log('Cantitate:', quantity);
        }).catch((error) => {
          console.error('Eroare la adăugarea unei intrări noi:', error);
        });
    }
  </script>
</body>

</html>
